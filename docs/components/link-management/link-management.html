<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Link Management</title>
<link type="text/css" href="../../../skin/page.css" rel="stylesheet">
</head>
<body text="#000000" bgcolor="#FFFFFF">
<!--================= start Banner ==================-->
<table summary="header with logos" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<!--================= start Group Logo ==================-->
<td valign="bottom" bgcolor="#FFFFFF">
<div class="headerlogo">
<a href="http://cocoon.apache.org"><img border="0" class="logoImage" alt="Apache Cocoon" src="../../../images/cocoon-project-logo-big.png"></a>
</div>
<span class="textheader">Apache Cocoon</span>
<!--================= start Tabs ==================-->
<div class="tab">
<table summary="tab bar" border="0" cellpadding="0" cellspacing="0">
<tr>
<td width="10" valign="bottom">
<div class="tab-separator">
<img alt="" width="10" src="../../../skin/images/spacer.gif"></div>
</td><td valign="bottom" class="tab">
<div class="tab-separator">
<table cellspacing="0" cellpadding="0" border="0">
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-left.png"></td><td rowspan="2" valign="bottom" class="tab">
<div class="tab-not-selected-shadow">
<div class="tab-not-selected">
<a href="../../../project/index.html"><font face="Arial, Helvetica, Sans-serif">Project Information</font></a>
</div>
</div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-right.png"></td>
</tr>
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="bottom">
<div class="tab-not-selected-shadow-left">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="bottom">
<div class="tab-not-selected-shadow-right">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td>
</tr>
</table>
</div>
</td><td valign="bottom" class="tab">
<div class="tab-separator">
<table cellspacing="0" cellpadding="0" border="0">
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-left.png"></td><td rowspan="2" valign="bottom" class="tab">
<div class="tab-not-selected-shadow">
<div class="tab-not-selected">
<a href="../../../installation/index.html"><font face="Arial, Helvetica, Sans-serif">Installation</font></a>
</div>
</div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-right.png"></td>
</tr>
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="bottom">
<div class="tab-not-selected-shadow-left">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="bottom">
<div class="tab-not-selected-shadow-right">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td>
</tr>
</table>
</div>
</td><td style="background-image: url(../../../skin/images/tab-left-selected.png)" valign="top" width="5"><img alt="" src="../../../skin/images/tab-corner-left-selected.png"></td><td valign="bottom" class="tab">
<div class="tab-selected">
<a href="../../index.html"><font color="#000000">Documentation</font></a>
</div>
</td><td style="background-image: url(../../../skin/images/tab-right-selected.png)" valign="top" width="5"><img alt="" src="../../../skin/images/tab-corner-right-selected.png"></td><td valign="bottom" class="tab">
<div class="tab-separator">
<table cellspacing="0" cellpadding="0" border="0">
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-left.png"></td><td rowspan="2" valign="bottom" class="tab">
<div class="tab-not-selected-shadow">
<div class="tab-not-selected">
<a href="../../../community/index.html"><font face="Arial, Helvetica, Sans-serif">Community</font></a>
</div>
</div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="top" width="5" height="5"><img alt="" src="../../../skin/images/tab-corner-right.png"></td>
</tr>
<tr>
<td style="background-image: url(../../../skin/images/tab-left.png)" valign="bottom">
<div class="tab-not-selected-shadow-left">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td><td style="background-image: url(../../../skin/images/tab-right.png)" valign="bottom">
<div class="tab-not-selected-shadow-right">
<img alt="" width="4" src="../../../skin/images/spacer.gif"></div>
</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<!--================= end Tabs ==================-->
</td>
<!--================= end Group Logo ==================-->
<!--================= start Project Logo ==================--><td width="100%" valign="bottom" align="right" bgcolor="#FFFFFF">
<div style="padding: 10px" class="headerlogo">
<a href="http://cocoon.apache.org/lenya"><img border="0" class="logoImage" alt="Lenya" src="../../../images/apache-lenya-light.png"></a>
</div>
<div class="tab-separator"></div>
</td>
<!--================= end Project Logo ==================-->
</tr>
</table>
<!--================= end Banner ==================-->
<div class="tab-bar">
<img alt="" height="5" src="../../../skin/images/spacer.gif"></div>
<!--================= start Menu, NavBar, Content ==================-->
<table summary="page content" bgcolor="#ffffff" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top">
<table summary="menu" border="0" cellspacing="0" cellpadding="0">
<tr>
<!--================= start left top NavBar ==================-->
<!--================= end left top NavBar ==================-->
<td valign="top">
<div class="tab-subbar">
<img width="10" height="5" alt="" src="../../../skin/images/spacer.gif"></div>
</td><td valign="top">
<!--================= start Menu items ==================-->
<div class="menu">
<div class="menutitle"></div>
<div class="menuitemgroup">
<div class="menutitle">Integrator/Dev Guide</div>
<div class="menuitemgroup">
<div class="menutitle">Components</div>
<div class="menuitemgroup">
<div class="menutitle">Link Management</div>
<div class="menuitemgroup">
<div class="menupage">
<div class="menupagetitle">Link Management</div>
<div class="menupageitemgroup">
<div class="menupageitem">
<a href="#Introduction">Introduction</a>
</div>
<div class="menupageitem">
<a href="#Implementation">Implementation</a>
</div>
<div class="menupageitem">
<a href="#Involved+classes%2C+XSPs+and+XSLTs">Involved classes, XSPs and XSLTs</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!--================= end Menu items ==================-->
</td><td valign="top">
<div class="tab-subbar">&nbsp;&nbsp;</div>
</td>
</tr>
<tr>
<td></td><td height="5"><img alt="" width="150" height="1" src="../../../skin/images/spacer.gif"></td><td></td>
</tr>
</table>
</td><td valign="top" width="100%">
<table summary="content" width="100%" border="0" cellpadding="0" cellspacing="0">
<tr>
<td valign="top" colspan="3">
<div class="tab-subbar">&nbsp;&nbsp;</div>
</td>
</tr>
<!--================= start Content==================-->
<tr>
<td align="left" width="10"><img width="10" height="1" alt="" src="../../../skin/images/spacer.gif"></td><td align="left" width="100%">
<div class="content">
<table cellspacing="0" cellpadding="0" class="title">
<tr>
<td valign="middle">
<h1>Link Management</h1>
</td><td nowrap="nowrap" width="40" align="center"><a class="dida" href="link-management.pdf"><img alt="PDF" src="../../../skin/images/pdfdoc.gif" border="0"><br>
          PDF</a></td>
</tr>
</table>
    
    
<a name="N101C9"></a><a name="Introduction"></a>
<h3>Introduction</h3>
<div style="margin-left: 0 ; border: 2px">
<p>Link Managements deals with internal links, i.e. documents
      that refer to other documents within the same publication. These
      links might have to be changed.</p>
<ol>
	
<li>if a document not yet live,</li>
	
<li>if it is withdrawn from live or </li>
	
<li>if its document-id has changed because it is moved to a
        different location within the site tree.</li>
	
<li>references in authoring have to link to documents in
	<span class="codefrag">authoring</span>, however once they are published they
	need to refer to documents in <span class="codefrag">live</span>
</li>
      
</ol>
<p>These four cases have to be dealt with seperately.</p>
<a name="N101E9"></a><a name="A+document+is+not+yet+live"></a>
<h4>A document is not yet live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>This case can happen if the user tries to publish a
	document which has a reference to another document which has
	not been published yet. The reference will be stale as the
	refered document is not in the live area yet. A warning will
	be issued during the publishing process.</p>
</div>
<a name="N101F3"></a><a name="A+document+is+withdrawn+from+live"></a>
<h4>A document is withdrawn from live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>If a document which is has references to it is withdrawn
	from the live area the references will be stale, as the
	refered document is no longer available in the live area. A
	warning will be issued during the deactivation process.</p>
</div>
<a name="N101FD"></a><a name="A+document-id+changes"></a>
<h4>A document-id changes</h4>
<div style="margin-left: 0 ; border: 2px">
<p>If a document is moved within the site tree such that it
	changes its document-id (e.g. cut a document and paste it
	somewhere else in the hierarchy in the site area) then all
	references to this document have to be changed. This is done
	transparently in the course of the paste.</p>
</div>
<a name="N10207"></a><a name="Rewrite+internal+links+in+live"></a>
<h4>Rewrite internal links in live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>Internal links refer to documents in authoring as long as
	they are not published. However as soon as they are published,
	i.e. reside in the live area their references have to go to
	documents in the live area. A transformer takes care of
	rewriting the internal links.</p>
</div>
</div>

    
<a name="N10212"></a><a name="Implementation"></a>
<h3>Implementation</h3>
<div style="margin-left: 0 ; border: 2px">
<p>The implementation is pretty
      straight-forward and is mostly handled in XSPs and associated
      helper classes. The heavy lifting us done is the class
      <span class="codefrag">Grep</span> and the helper class
      <span class="codefrag">DocumentReferencesHelper</span>. The <span class="codefrag">Grep</span>
      class can traverse the repository and find references to the
      current document or can also find references from the current
      document to other documents. A transformer
      (SimpleLinkRewritingTransformer) is used to rewrite the internal
      links in the live area.</p>
<a name="N10224"></a><a name="A+document+is+not+yet+live-N10224"></a>
<h4>A document is not yet live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>This is implemented as an extension to the publish xsp. It
	  queries the <span class="codefrag">DocumentReferencesHelper</span> (using the
	  <span class="codefrag">getInternalReferences</span> method) to ask if there
	  are references from the current document to other documents
	  which have not been published yet. The
	  <span class="codefrag">DocumentReferencesHelper</span> in turn uses the
	  <span class="codefrag">Grep#findPattern</span> method to search the current
	  document for patterns of a reference. The pattern is defined
	  in <span class="codefrag">DocumentReferencesHelper#getInternalLinkPattern</span>.</p>
</div>
<a name="N1023D"></a><a name="A+document+is+withdrawn+from+live-N1023D"></a>
<h4>A document is withdrawn from live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>This is implemented as an extension to the deactivate
	  xsp. It queries the <span class="codefrag">DocumentReferencesHelper</span>
	  (using the <span class="codefrag">getReferences</span> method) to ask if any
	  other documents refer to the current document. The
	  <span class="codefrag">DocumentReferencesHelper</span> in turn uses the
	  <span class="codefrag">Grep#find</span> method to search the repository for
	  documents which contain a patterns of a reference. The
	  pattern is defined in
	  <span class="codefrag">DocumentReferencesHelper#getReferencesSearchString()</span>.</p>
</div>
<a name="N10256"></a><a name="A+document-id+changes-N10256"></a>
<h4>A document-id changes</h4>
<div style="margin-left: 0 ; border: 2px">
<p>This is implemented with an ant task
	  (<span class="codefrag">org.apache.lenya.cms.ant.LinkRewriteTask</span>)
	  which traverses the repository and pipes all documents
	  through an XSLT stylesheet
<!-- 	FIXME: move the unizh stuff into the core. -->
	  (<span class="codefrag">unizh/pubs/unizh/xslt/linkRewrite.xsl</span>) to
	  modify all references to the document that changed its
	  document-id.
	</p>
</div>
<a name="N10268"></a><a name="Rewrite+internal+links+in+live-N10268"></a>
<h4>Rewrite internal links in live</h4>
<div style="margin-left: 0 ; border: 2px">
<p>The
	  <span class="codefrag">org.apache.lenya.cms.cocoon.transformation.SimpleLinkRewritingTransformer</span>
	  transformer takes care of rewriting internal links to ensure
	  they refer to the appropriate area.
	</p>
</div>
</div>

    
<a name="N10276"></a><a name="Involved+classes%2C+XSPs+and+XSLTs"></a>
<h3>Involved classes, XSPs and XSLTs</h3>
<div style="margin-left: 0 ; border: 2px">
<p>The following classes, XSPs and XSLTs are involved in link
      management:</p>
<dl>
	
<dt>org.apache.lenya.cms.publication.xsp.DocumentReferencesHelper</dt>
	
<dd>A helper class for the publish and deactivate
	xsps. Defines the regular expressions for internal links. Has
	methods to deteremine all references from the current document
	to other documents (<span class="codefrag">getInternalReferences</span>) and to
	determine all references from other documents to the current
	document (<span class="codefrag">getReferences</span>).</dd>
	
<dt>org.apache.lenya.search.Grep</dt>
	
<dd>User by <span class="codefrag">DocumentReferencesHelper</span> to search
	for patterns in a file or in a directory tree.</dd> 
	
<dt>org.apache.lenya.cms.ant.LinkRewriteTask</dt>
	
<dd>An ant task that upon change of a document-id pipes all
	documents of the repository through a XSLT stylesheet which
	rewrites internal links that were refering to the old
	document-id to refere to the new one.</dd> 
	
<dt>org.apache.lenya.cms.cocoon.transformation.SimpleLinkRewritingTransformer</dt>
	
<dd>A transformer that rewrites internal links for the
	appropriate area.</dd>
	
<dt>$publication-id/config/tasks/targets.xml</dt>
	
<dd>Defines the <span class="codefrag">move-and-rewrite</span> target which
	handles the link rewriting in the case of a paste, i.e. when a
	document-id has changed.</dd>  
<!-- 	FIXME: move the unizh stuff into the core. -->
	
<dt>unizh/pubs/unizh/xslt/linkRewrite.xsl</dt>
	
<dd>The XSLT transformation used by
	<span class="codefrag">LinkRewriteTask</span> to actually rewrite the internal links.</dd>
	
<dt>src/webapp/lenya/content/publishing/screen.xsp, src/webapp/lenya/xslt/publishing/publish-screen.xsl</dt>
	
<dd>Query the <span class="codefrag">DocumentReferencesHelper</span> to display
	a warning in case the current document contains references to
	documents which have not been published yet.</dd>
	
<dt>src/webapp/lenya/content/info/deactivate.xsp, src/webapp/lenya/xslt/info/deactivate.xsl</dt>
	
<dd>Query the <span class="codefrag">DocumentReferencesHelper</span> to display
	a warning in case there are links to the current document
	which is about to be deactivated.</dd>
      
</dl>
</div>
  
</div>
</td><td width="10"><img width="10" height="1" alt="" src="../../../skin/images/spacer.gif"></td>
</tr>
<!--================= end Content==================-->
</table>
</td>
</tr>
<tr>
<td>
<br>
<br>
</td>
</tr>
</table>
<!--================= end Menu, NavBar, Content ==================-->
<!--================= start Footer ==================-->
<div class="footer">
<table summary="footer" cellspacing="0" cellpadding="0" width="100%" border="0">
<tr>
<td colspan="2" height="1"><img height="1" width="1" alt="" src="../../../skin/images/spacer.gif"><a href="../../../skin/images/label.gif"></a><a href="../../../skin/images/page.gif"></a><a href="../../../skin/images/chapter.gif"></a><a href="../../../skin/images/chapter_open.gif"></a><a href="../../../skin/images/current.gif"></a></td>
</tr>
<tr>
<td colspan="2" class="copyright" align="center" width="90%"><span class="footnote">Copyright &copy;
                2002-2003&nbsp;The Apache Software Foundation. All rights reserved.
                <br>
<script type="text/javascript" language="JavaScript"><!--
                  document.write(" - "+"Last Published: " + document.lastModified);
                  //  --></script></span></td><td nowrap="nowrap" align="right" class="logos"><a href="http://validator.w3.org/check/referer"><img width="88" height="31" alt="Valid HTML 4.01!" src="../../../skin/images/valid-html401.png" class="logoImage" border="0"></a><a href="http://jigsaw.w3.org/css-validator/"><img width="88" height="31" alt="Valid CSS!" src="../../../skin/images/vcss.png" class="logoImage" border="0"></a></td>
</tr>
</table>
</div>
<!--================= end Footer ==================-->
</body>
</html>
