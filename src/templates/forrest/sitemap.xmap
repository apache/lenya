<?xml version="1.0" encoding="UTF-8"?>
<!-- CVS: $Id: sitemap.xmap,v 1.17 2003/07/23 10:28:52 gregor Exp $ -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  
  <map:components>
    <map:generators default="file"/>
    <map:transformers default="xslt"/>
    <map:readers default="resource"/>
    <map:serializers default="html"/>
    <map:matchers default="wildcard"/>
    <map:selectors>
      <map:selector name="request-method" logger="sitemap.selector.request-method"
        src="org.apache.cocoon.selection.RequestMethodSelector"/>
    </map:selectors>
    <map:actions/>
  </map:components>
  
  <map:resources>
    <map:resource name="style-cms-page">
      <map:transform src="../../xslt/util/page2xhtml.xsl">
        <map:parameter name="contextprefix" value="{request:contextPath}"/>
      </map:transform>
      <map:select type="parameter">
        <map:parameter name="statusCode" value="{statusCode}"/>
        <map:when test="">
          <map:serialize/>
        </map:when>
        <map:otherwise>
          <map:serialize status-code="{statusCode}"/>
        </map:otherwise>
      </map:select>
    </map:resource>
  </map:resources>

  <map:pipelines>
    
    <!-- BX Editor: Entries -->
    <map:pipeline>
      <map:match pattern="**/*-bxeng.html">
        <map:aggregate element="bxeng">
          <map:part src="../../resources/misc/bxeng/index.xhtml"/>
          <map:part src="resources/misc/bxeng/content-namespaces.xml"/>
        </map:aggregate>
        <map:transform src="../../xslt/bxeng/aggregate.xsl"/>
        <map:transform src="../../xslt/bxeng/index-xhtml.xsl">
          <map:parameter name="configfile" value="./{2}-config-bxeng.xml"/>
        </map:transform>
        <map:serialize type="xhtml-iso-8859-1"/>
      </map:match>
    </map:pipeline>
    <map:pipeline>
      <map:match pattern="**/*-config-bxeng.xml">
        <map:generate src="../../resources/misc/bxeng/inc/config.xml"/>
        <map:transform src="../../xslt/bxeng/config-xml.xsl">
          <map:parameter name="BX_xmlfile" value="{2}-bxeng.xml"/>
<!--      Instead of an xsl we use the xhtml file to provide the basic layout
          <map:parameter name="BX_xslfile" value="{2}.xsl"/>
-->
          <map:parameter name="BX_xhtmlfile" value="{2}.xhtml"/>
          <map:parameter name="BX_validationfile" value="xhtml/xhtml.rng"/>
          <map:parameter name="css" value="content-bxeng.css"/>
          <map:parameter name="BX_exitdestination" value="{2}.html"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
    <!-- GET and PUT -->
    <map:pipeline type="noncaching">
      <map:match pattern="*/**-bxeng.xml">
        <map:select type="request-method">
          <map:when test="PUT">
          </map:when>
          <map:otherwise> <!-- GET -->
<!--
            <map:generate src="cocoon:/lenyabody/{2}.html"/>
            <map:transform src="xslt/html2xhtml.xsl"/>
-->
            <map:generate src="content/xdocs/{2}.xml"/>
            <map:serialize type="xml"/>
          </map:otherwise>
        </map:select>
      </map:match>
      <map:handle-errors type="500"/>
    </map:pipeline>
    <!-- /GET and PUT -->
    <map:pipeline>
      <map:match pattern="**/content-bxeng.xsl">
        <map:generate src="xslt/content-bxeng.xsl"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/**.rng">
        <map:generate src="resources/schema/{2}.rng"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="**/content-bxeng.css">
        <map:read src="skins/{forrest:skin}/css/page.css" mime-type="text/css"/>
      </map:match>
      <map:handle-errors type="500"/>
    </map:pipeline>
    <!-- /BX Editor: Entries -->
    
    <!-- main pipeline -->
    <map:pipeline>
      
      <!-- Forrest pages -->
      <map:match pattern="lenyabody/**">
        <map:mount src="forrest-sitemap.xmap" uri-prefix="lenyabody/"/>
      </map:match>
      
      <!-- HTML pages -->
      <!-- {area}/{uri}.html -->
      <map:match pattern="*/**.html">
        <map:generate src="cocoon:/lenyabody/{2}.html"/>
        <map:transform src="xslt/html2xhtml.xsl"/>
        <map:transform src="cocoon://lenya-page/{page-envelope:publication-id}/{page-envelope:area}{page-envelope:document-url}"/>
        <map:serialize/>
      </map:match>
      
      <!-- The xhtml pipeline is used to generate the XSLT for bxeng (Bitflux) dynamically.
           It uses the authoring XML and the live XSLT. The Lenya menubar is
           not attached. -->
      <map:match pattern="*/**.xhtml">
<!--
        <map:generate src="cocoon:/lenyabody/{2}.html"/>
        <map:transform src="xslt/remove-xhtml-ns.xsl"/>
        <map:transform src="xslt/html2xhtml.xsl"/>
        <map:generate src="uni.xhtml.xml"/>
-->
        <map:generate src="index.xhtml.xml"/>
        <map:serialize type="xml"/>
      </map:match>

      <!-- Generates the xslt for bxeng (Bitflux) dynamically using the xhtml of the page and replacing <span bxe-editable='xxx'> -->
      <map:match pattern="**.xsl">
        <map:generate src="cocoon:/{1}.xhtml"/>
        <map:transform src="xslt/authoring/bxeng-meta.xsl"/>
        <map:serialize type="xml"/>
      </map:match>
     
      <!-- resources -->
      <!-- {area}/{uri} -->
      <map:match pattern="*/**">
        <map:mount src="forrest-sitemap.xmap" uri-prefix="{1}/"/>
      </map:match>
      
      <map:handle-errors type="500">
        <map:serialize type="xml"/>
      </map:handle-errors>
      
    </map:pipeline>
    
  </map:pipelines>
  
</map:sitemap>
