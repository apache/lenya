<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

<!-- =========================== Components ================================ -->

 <map:components>
   
  <map:generators default="file">
    <map:generator label="content,data" logger="sitemap.generator.file" name="file" pool-grow="4" pool-max="32" pool-min="8" src="org.apache.cocoon.generation.FileGenerator"/>
    <map:generator label="content,data" logger="sitemap.generator.file-nolabel" name="file-nolabel" pool-grow="4" pool-max="32" pool-min="8" src="org.apache.cocoon.generation.FileGenerator"/>
    <map:generator label="content,data" logger="sitemap.generator.serverpages" name="serverpages" pool-grow="2" pool-max="32" pool-min="4" src="org.apache.cocoon.generation.ServerPagesGenerator"/>
<!-- =========================== Lenya CMS ================================= -->
    <map:generator name="servletproxy" src="org.apache.lenya.cms.cocoon.generation.ProxyGenerator"/>
  </map:generators>

  <map:transformers default="xslt">

    <map:transformer name="xlink" src="org.apache.lenya.cms.cocoon.transformation.IncludeTransformer">
      <publication type=""/>
    </map:transformer>

    <!-- NOTE: XSLTC is now the default processor. If you use Xalan extensions, use the "xalan" transformer. -->
    <map:transformer logger="sitemap.transformer.xslt" name="xslt" pool-grow="2" pool-max="32" pool-min="8" src="org.apache.cocoon.transformation.TraxTransformer">
      <use-request-parameters>false</use-request-parameters>
      <use-session-parameters>false</use-session-parameters>
      <use-cookie-parameters>false</use-cookie-parameters>
      <transformer-factory>org.apache.xalan.xsltc.trax.TransformerFactoryImpl</transformer-factory>
    </map:transformer>

    <!-- NOTE: This used to be the default XSLT processor. The default now is XSLTC -->
    <map:transformer logger="sitemap.transformer.xalan" name="xalan" pool-grow="2" pool-max="32" pool-min="8" src="org.apache.cocoon.transformation.TraxTransformer">
      <use-request-parameters>false</use-request-parameters>
      <use-session-parameters>false</use-session-parameters>
      <use-cookie-parameters>false</use-cookie-parameters>
      <transformer-factory>org.apache.xalan.processor.TransformerFactoryImpl</transformer-factory>
    </map:transformer>

  </map:transformers>

  <map:serializers default="html">
    <map:serializer logger="sitemap.serializer.links" name="links" src="org.apache.cocoon.serialization.LinkSerializer"/>
    <map:serializer logger="sitemap.serializer.xml" mime-type="text/xml" name="xml" src="org.apache.cocoon.serialization.XMLSerializer"/>
    <map:serializer logger="sitemap.serializer.html" mime-type="text/html" name="html" pool-grow="4" pool-max="32" pool-min="4" src="org.apache.cocoon.serialization.HTMLSerializer">
      <buffer-size>1024</buffer-size>
    </map:serializer>
    <map:serializer logger="sitemap.serializer.xhtml" mime-type="text/html" name="xhtml" pool-grow="2" pool-max="64" pool-min="2" src="org.apache.cocoon.serialization.XMLSerializer">
      <doctype-public>-//W3C//DTD XHTML 1.0 Strict//EN</doctype-public>
      <doctype-system>http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</doctype-system>
      <encoding>UTF-8</encoding>
    </map:serializer>
    <map:serializer logger="sitemap.serializer.text" mime-type="text/plain" name="text" src="org.apache.cocoon.serialization.TextSerializer"/>
  </map:serializers>

  <map:readers default="resource">
    <map:reader logger="sitemap.reader.resource" name="resource" pool-max="32" src="org.apache.cocoon.reading.ResourceReader"/>
  </map:readers>

  <map:matchers default="wildcard">
    <map:matcher logger="sitemap.matcher.wildcard" name="wildcard" src="org.apache.cocoon.matching.WildcardURIMatcher"/>
    <map:matcher logger="sitemap.matcher.regexp" name="regexp" src="org.apache.cocoon.matching.RegexpURIMatcher"/>
    <map:matcher logger="sitemap.matcher.request-parameter" name="request-parameter" src="org.apache.cocoon.matching.RequestParameterMatcher"/>
    <map:matcher name="usecase" logger="sitemap.matcher.usecase" src="org.apache.cocoon.matching.WildcardRequestParameterMatcher">
      <parameter-name>lenya.usecase</parameter-name>
    </map:matcher>
    <map:matcher name="step" logger="sitemap.matcher.step" src="org.apache.cocoon.matching.WildcardRequestParameterMatcher">
      <parameter-name>lenya.step</parameter-name>
    </map:matcher>
  </map:matchers>

  <map:selectors default="browser">
   <map:selector logger="sitemap.selector.request-parameter" name="request-parameter" src="org.apache.cocoon.selection.RequestParameterSelector">
    <!-- Define now which request parameter to use; or do it later,
         when using this selector, via "parameter-name" parameter.
    <parameter-name>myparam</parameter-name> 
    -->
   </map:selector>
   
   <map:selector logger="sitemap.selector.resource-exists" name="resource-exists" src="org.apache.cocoon.selection.ResourceExistsSelector"/>
</map:selectors>

  <map:actions>
   <map:action logger="sitemap.action.request" name="request" src="org.apache.cocoon.acting.RequestParamAction"/>

<!-- =========================== Lenya CMS ================================= -->

   <map:action name="parent-child" logger="sitemap.action.parent-child" src="org.apache.lenya.cms.cocoon.acting.ParentChildCreatorAction">
        <tree-authoring href="content/authoring/tree.xml"/>
        <docs href="content/authoring"/>
        <doctypes href="config/doctypes/"/>
   </map:action>
      <map:action name="xopushandler" logger="sitemap.action.xopus" src="org.apache.lenya.cms.cocoon.acting.XopusHandlerAction">
        <xml href="content/authoring/"/>
        <xsl href="xslt"/>
        <xsd href="config/doctypes/schemas"/>
        <temp href="temp"/>
        <rcmlDirectory href="content/rcml"/>
        <backupDirectory href="content/rcbak"/>
      </map:action>
      <map:action name="page-envelope" src="org.apache.lenya.cms.cocoon.acting.PageEnvelopeAction" logger="sitemap.action.page-envelope"/> 
	  <map:action name="reserved-checkout" src="org.apache.lenya.cms.cocoon.acting.ReservedCheckoutAction" logger="sitemap.action.reserved-checkout"/>
	  <map:action name="reserved-checkin" src="org.apache.lenya.cms.cocoon.acting.ReservedCheckinAction" logger="sitemap.action.reserved-checkin"/>
	  <map:action name="rollback" src="org.apache.lenya.cms.cocoon.acting.RollbackAction"/>

      <map:action name="file-upload" logger="sitemap.action.upload" src="org.apache.lenya.cms.cocoon.acting.ArticleImageUploadCreatorAction">
        <resources-root href="resources/images/live"/>
        <docs-root href="content/authoring"/>
        <meta-root href="content/authoring/"/>
        <insert-image-before value="false"/>
      </map:action>
      
      <map:action name="task" logger="sitemap.action.task" src="org.apache.lenya.cms.cocoon.acting.TaskAction"/>
      
      <map:action name="uriparametrizer" src="org.apache.lenya.cms.cocoon.acting.URIParametrizerAction" logger="sitemap.action.uriparametrizer"/>
    
      <map:action name="default-create" src="org.apache.lenya.cms.cocoon.acting.DefaultCreatorAction" logger="sitemap.action.default-create">
        <tree-authoring href="content/authoring/sitetree.xml"/>
        <docs href="content/authoring"/>
        <doctypes href="config/doctypes/"/>
      </map:action>
      
      <map:action logger="sitemap.action.multipart" name="multipart" src="org.apache.lenya.cms.cocoon.acting.MultipartHttpServletRequestAction"/>

      <map:action logger="sitemap.action.resource-exists-enhanced" name="resource-exists-enhanced" src="org.apache.lenya.cms.cocoon.acting.ResourceExistsAction"/>
      
      <map:action name="authorizer" src="org.apache.lenya.cms.cocoon.acting.DelegatingAuthorizerAction" logger="lenya.sitemap.action.authorizer"/>
      <map:action name="authenticator" src="org.apache.lenya.cms.cocoon.acting.DelegatingAuthenticatorAction" logger="lenya.sitemap.action.authenticator"/>
      
   </map:actions>

   <map:pipes default="caching">
     <map:pipe name="caching" src="org.apache.cocoon.components.pipeline.impl.CachingProcessingPipeline"/>
     <map:pipe name="caching-point" src="org.apache.cocoon.components.pipeline.impl.CachingPointProcessingPipeline">
       <autoCachingPoint>On</autoCachingPoint>
     </map:pipe>
     <map:pipe name="noncaching" src="org.apache.cocoon.components.pipeline.impl.NonCachingProcessingPipeline"/>
   
     <!-- The following two can be used for profiling:-->
     <map:pipe name="profile-caching" src="org.apache.cocoon.components.profiler.ProfilingCachingProcessingPipeline"/>
     <map:pipe name="profile-noncaching" src="org.apache.cocoon.components.profiler.ProfilingNonCachingProcessingPipeline"/>
</map:pipes>

 </map:components>

<!-- =========================== Views =================================== -->

  <!--+
      | Views provide diffent, well, views to resources. Views are
      | orthogonal to pipelines. Please refer to the docs.
      +-->
  <map:views>

    <map:view name="first" from-position="first">
      <map:serialize type="xml"/>
    </map:view>

    <map:view name="last" from-position="last">
      <map:serialize type="xml"/>
    </map:view>

    <map:view from-label="content" name="content">
      <map:serialize type="xml"/>
    </map:view>

    <map:view from-label="data" name="pretty-content">
      <map:transform src="stylesheets/simple-xml2html.xsl"/>
      <map:serialize type="html"/>
    </map:view>

    <map:view from-position="last" name="links">
      <map:serialize type="links"/>
    </map:view>

    <map:view from-label="aggregate" name="aggregate">
      <map:serialize type="xml"/>
    </map:view>
  </map:views>

<!-- =========================== Resources ================================= -->

  <map:resources>

    <map:resource name="style-cms-page">
      <map:transform src="lenya/xslt/util/page2xhtml.xsl">
        <map:parameter name="contextprefix" value="{request:contextPath}"/>
      </map:transform>
      <map:serialize/>
    </map:resource>
   
 </map:resources>

<!-- =========================== Pipelines ================================= -->

  <map:pipelines>

    <map:pipeline>
      
      <map:match  type="usecase" pattern="login">
        
        <map:match type="step" pattern="showscreen">
          <map:generate type="serverpages" src="lenya/content/ac/login.xsp"/>
          <map:transform src="lenya/xslt/ac/login.xsl">
            <map:parameter name="publication_name" value="Unknown Publication"/>
          </map:transform>
          <map:call resource="style-cms-page"/>
        </map:match>
        
        <map:match type="step" pattern="login">
          <map:act type="authenticator">
            <map:redirect-to uri="{request:requestURI}" session="true"/>
          </map:act>
          <map:redirect-to uri="{request:requestURI}?lenya.usecase=login&amp;lenya.step=showscreen&amp;status=failed" session="true"/>
        </map:match>
        
      </map:match>
      
      <map:match type="usecase" pattern="logout">
        <map:generate type="serverpages" src="lenya/content/ac/logout.xsp"/>
        <map:transform src="lenya/xslt/ac/logout.xsl">
          <map:parameter name="publication_name" value="Unknown Publication"/>
        </map:transform>
        <map:serialize/>
      </map:match>

    </map:pipeline>

    <map:pipeline internal-only="true">
      <map:match pattern="**">
        <map:mount uri-prefix="" src="global-sitemap.xmap" check-reload="true" reload-method="synchron"/>
      </map:match>
    </map:pipeline>
      
    <map:pipeline>
      <map:match pattern="**">
        <map:act type="authorizer">
          <map:mount uri-prefix="" src="global-sitemap.xmap" check-reload="true" reload-method="synchron"/>
        </map:act>
        <map:redirect-to uri="{request:requestURI}?lenya.usecase=login&amp;lenya.step=showscreen" session="true"/>
      </map:match>
    </map:pipeline>

  </map:pipelines>

</map:sitemap>
