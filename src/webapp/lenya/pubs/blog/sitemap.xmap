<?xml version="1.0"?>

<!-- CVS: $Id: sitemap.xmap,v 1.26 2003/08/30 23:10:46 michi Exp $ -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:components/>

  <map:views/>

  <map:resources/>

  <map:pipelines>

    <!-- CSS, path independent (mod_proxy) -->
    <map:pipeline>
      <map:match pattern="**/css/styles.css">
        <map:read src="resources/css/styles.css" mime-type="text/css"/>
      </map:match>
    </map:pipeline>
  
    <!-- Redirects -->
    <map:pipeline>
      <map:match pattern="">
        <map:redirect-to uri="introduction.html"/>
      </map:match>
      <map:match pattern="index.html">
        <map:redirect-to uri="introduction.html"/>
      </map:match>
      <map:match pattern="*/">
        <map:redirect-to uri="feeds/all/index.html"/>
      </map:match>
      <map:match pattern="*/index.html">
        <map:redirect-to uri="feeds/all/index.html"/>
      </map:match>
      <!-- The HTML Form Editor does send a redirect -->
      <map:match pattern="*/sidebar.html">
        <map:redirect-to uri="feeds/all/index.html"/>
      </map:match>
    </map:pipeline>

    <!-- WebDAV -->
    <map:pipeline>
      <map:match pattern="webdav/**">
        <map:mount src="webdav.xmap" uri-prefix="webdav" check-reload="yes"/>
      </map:match>
    </map:pipeline>

    <!-- Entries -->
    <map:pipeline>
      <map:match pattern="*/entries/*/*/*/*/index.xml">
        <map:aggregate element="feed">
          <map:part src="content/{1}/feeds/all/index.xml"/>
          <map:part src="content/{1}/entries/{2}/{3}/{4}/{5}/index.xml"/>
          <map:part src="content/{1}/sidebar.xml"/>
        </map:aggregate>
        <map:transform src="xslt/entry/aggregate.xsl"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/entries/*/*/*/*/lenya-page-body.xml">
        <map:aggregate element="cmsbody">
          <map:part src="cocoon:/{1}/entries/{2}/{3}/{4}/{5}/index.xml"/>
          <map:part src="content/{1}/sidebar.xml"/>
        </map:aggregate>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/entries/*/*/*/*/index.html">
        <map:aggregate element="lenya">
          <map:part src="cocoon:/{1}/menubar/entry.xml"/>
          <map:part src="cocoon:/{1}/entries/{2}/{3}/{4}/{5}/lenya-page-body.xml"/>
        </map:aggregate>
        <map:transform src="xslt/entry/main-{1}.xsl"/>
        <map:serialize type="html"/>
      </map:match>
      <map:handle-errors type="500">
        <!-- FIXME: can also contain other errors than "not published yet" -->
        <map:transform src="../../xslt/exception/not_published_yet.xsl"/>
        <map:transform src="../../xslt/util/page2xhtml.xsl"/>
        <map:serialize type="html"/>
      </map:handle-errors>
    </map:pipeline>

    <!-- BX Editor: Entries -->
    <map:pipeline>
      <map:match pattern="*/entries/*/*/*/*/index-bxeng.html">
<!--
        <map:read src="resources/misc/bxeng/entry.xhtml" mime-type="text/html"/>
-->
<!--
        <map:generate src="resources/misc/bxeng/entry.xhtml"/>
        <map:serialize type="xhtml-bxeng"/>
-->
        <map:aggregate element="bxeng">
          <map:part src="../../resources/misc/bxeng/index.xhtml"/>
          <map:part src="resources/misc/bxeng/entry-namespaces.xml"/>
        </map:aggregate>
        <map:transform src="../../xslt/bxeng/aggregate.xsl"/>
        <map:transform src="../../xslt/bxeng/index-xhtml.xsl">
          <map:parameter name="configfile" value="./config-bxeng.xml"/>
        </map:transform>
        <map:serialize type="xhtml-bxeng"/>
      </map:match>
    </map:pipeline>
    <map:pipeline>
      <map:match pattern="*/entries/*/*/*/*/config-bxeng.xml">
        <map:generate src="../../resources/misc/bxeng/inc/config.xml"/>
        <map:transform src="../../xslt/bxeng/config-xml.xsl">
          <map:parameter name="BX_xmlfile" value="../../../../../../webdav/entries/{2}/{3}/{4}/{5}/index.xml"/>
          <map:parameter name="BX_xslfile" value="entry-bxeng.xsl"/>
          <map:parameter name="css" value="entry-bxeng.css"/>
          <map:parameter name="BX_exitdestination" value="index.html"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
    <map:pipeline>
      <map:match pattern="*/entries/*/*/*/*/entry-bxeng.xsl">
        <map:generate src="xslt/entry/bxeng.xsl"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/entries/*/*/*/*/entry-bxeng.css">
        <map:read src="resources/misc/bxeng/entry.css" mime-type="text/css"/>
      </map:match>
      <map:handle-errors type="500"/>
    </map:pipeline>
    <!-- /BX Editor: Entries -->

    <!-- Feeds -->
    <map:pipeline>
      <map:match pattern="*/feeds/*/index.xml">
        <map:generate type="directory" src="content/{1}/entries">
          <map:parameter name="depth" value="4"/>
          <map:parameter name="reverse" value="true"/>
        </map:generate>
        <map:transform src="xslt/feed/xinclude.xsl">
          <map:parameter name="feedid" value="{2}"/>
        </map:transform>
        <map:transform type="xlink">
          <map:parameter name="href" value="content/{1}/dummy.xml"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/feeds/*/lenya-page-body.xml">
        <map:aggregate element="cmsbody">
          <map:part src="cocoon:/{1}/feeds/{2}/index.xml"/>
          <map:part src="content/{1}/sidebar.xml"/>
        </map:aggregate>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="*/feeds/*/index.html">
        <map:aggregate element="lenya">
          <map:part src="cocoon:/{1}/menubar/feed.xml"/>
          <map:part src="cocoon:/{1}/feeds/{2}/lenya-page-body.xml"/>
        </map:aggregate>
        <map:transform src="xslt/feed/main-{1}.xsl"/>
        <map:serialize type="html"/>
      </map:match>
      <map:handle-errors type="500">
        <!-- FIXME: can also contain other errors than "not published yet" -->
        <map:transform src="../../xslt/exception/not_published_yet.xsl"/>
        <map:transform src="../../xslt/util/page2xhtml.xsl"/>
        <map:serialize type="html"/>
      </map:handle-errors>
    </map:pipeline>

    <!-- Archives -->
    <map:pipeline>
      <map:match pattern="*/archives/*/*/">
        <map:generate type="directory" src="content/{1}/entries/{2}/{3}/">
          <map:parameter name="depth" value="2"/>
          <map:parameter name="reverse" value="true"/>
        </map:generate>
        <map:serialize type="xml"/>
      </map:match>
      <map:handle-errors type="500">
        <map:serialize type="xml"/>
      </map:handle-errors>
    </map:pipeline>

    <!-- Menubars -->
    <map:pipeline>
      <map:match pattern="authoring/menubar/entry.xml">
        <map:generate type="serverpages" src="config/menus/entry.xsp"/>
        <map:transform type="usecasemenu"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="authoring/menubar/feed.xml">
        <map:generate type="serverpages" src="config/menus/feed.xsp"/>
        <map:transform type="usecasemenu"/>
        <map:serialize type="xml"/>
      </map:match>
      <map:match pattern="live/menubar/*.xml">
        <map:generate type="serverpages" src="../../content/menus/live.xsp"/>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
