<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V1.1//EN" "document-v11.dtd">

<document> 

<header> 
    <title>The MailTask</title>
    <version>0.1</version> 
    <type>Overview document</type> 
    <authors>
      <person name="Andreas Hartmann" email="andreas.hartmann@lenya.org"/> 
    </authors> 
</header> 
<body> 

<p>
A <code>MailTask</code> sends an e-mail. The parameters, such as recipient
address, subject, and body, can either be provided as a task parameter or
extracted from an XML document.
</p>

<section>
<title>Task Parameters</title>

<p>
The following parameters must be provided:</p>
<ul>
  <li><strong>server</strong>: the SMTP server URI</li>
  <li><strong>from</strong>: you@yourhost.com</li>
  <li><strong>to</strong>: friend@mail.com</li>
  <li><strong>cc</strong>: other-friends@mail.com</li>
  <li><strong>subject</strong>: Hello World!</li>
  <li><strong>body</strong>: How are you?</li>
</ul>


<section><title>Getting the mail data from an XML source</title>
<p>
Additionally, you can pass a <code>uri</code> parameter to the <code>MailTask</code>:</p>
<ul>
  <li><strong>uri</strong>: the URI to get the XML file from</li>
</ul>
<p>If this parameter is present, the task tries to fetch an XML document from the URI.
If the parameter <code>uri</code> starts with a <code>http://</code> or <code>ftp://</code>
prefix, the absolute URI is used. If not, the URI is interpreted as relative to the
local publication.</p>
<p>
A complete XML document could look like this:
</p>
<source><![CDATA[

<mail:mail xmlns:mail="http://www.lenya.org/2002/mail">
  <mail:server>mail.yourhost.com</mail:server>
  <mail:from>you@yourhost.com</mail:from>
  <mail:to>friend@mail.com</mail:to>
  <mail:cc>other-friends@mail.com</mail:cc>
  <mail:subject>Hello Friends!</mail:subject>
  <mail:body>How are you?</mail:body>
</mail:mail>

]]></source>
<p>
All child elements of <code>&lt;mail:mail&gt;</code> are optional.
If the <code>uri</code> task parameter is provided, the XML
document is fetched from the URI and the parameters are extracted.
</p>
<p>
Task parameters have a higher priority than elements of the document. This makes it
possible to access one complete XML file from different <code>MailTask</code>s and override
the recepient address or other values.
</p>
</section>
</section>

<section><title>Declaring and Using the MailTask</title>
<p>
In <code>tasks.xconf</code>, a typical mail task looks like follows:
</p>
<source><![CDATA[

  <task id="send-newsletter" class="org.lenya.cms.mail.MailTask">
    <label>Send Newsletter</label>
    <parameter name="server" value="mail.lenya.net"/>
    <parameter name="from" value="info@lenya.org"/>
    <parameter name="to" value="newsletter-subscribers@lenya.org"/>
    <parameter name="uri" value="/authoring/newsletter/mail.xml"/>
  </task>

]]></source>
<p>
The actual newsletter is received from the URI that is interpreted
relativly to the publication URI. The task can be invoked in a sitemap pipeline:
</p>
<source><![CDATA[

  <map:action name="task" src="org.lenya.cms.cocoon.acting.TaskAction"/>
  
  ...
  
  <map:match pattern="newsletter/send">
    <map:act type="task">
      <map:parameter name="task-id" value="send-newsletter"/>
      <map:redirect-to uri="report-success.html" session="true"/>
    </map:act>
    <map:redirect-to uri="report-failure.html" session="true"/>
  </map:match>

]]></source>
</section>

</body>
</document>