<?xml version="1.0" encoding="UTF-8"?>

  <document>
  <header>
    <title>File Upload</title>
    <version>1.0</version>
    <type>Overview document</type>
    <authors>
      <person name="Christian Egli" email="christian.egli@wyona.org"/>
    </authors>
    <notice></notice>
    <abstract></abstract>
  </header>
  <body>
    <s1 title="File Upload">
      <s2 title="What is it?">
	<p>The file upload in wyona allows the user to upload arbitrary
	  files to the web server. It is implemented as a cocoon
	  action.</p>
      </s2>
    <s2 title="How does it work">
      <p>The basic idea of how it works is as follows:</p>
      <ol>
	<li>You have a link in your existing document which invokes
	the upload form and passes it the xpath of itself.</li>
	<li>Once you're in the upload form you enter the file name of
	the file that you want to upload along with some additional
	(dublin core) information such as description, keywords,
	title, creator, etc. </li>
	<li>The submit button of the form then does a post which is
	handled in a cocoon action.
	  <ol>
	    <li>The action copies the file into an appropriate
	    directory,</li>
	    <li>creates a meta xml file that contains all the dublin
	    core metae information for the uploaded file</li>
	    <li>and inserts a &lt;media&gt; element at the xpath where the
	    originating link was in the requesting document.</li> 
	  </ol>
	</li>
	<li>After the action the sitemap does a redirect to the
	original document where the image is now inserted (with
	appropriate caption, alt tag, etc.).</li> 
      </ol>
    </s2>
    <s2 title="How to use it in my publication?">
      <p>In order to use the file upload action for your own
      publication you have to do the following:</p>
      <ol>
	<li>Add an action and a matcher to your sitemap</li> 
	<li>Create a form that generates a post request. For that it
	recomended that you use and possibly adapt
	<code>upload-image.xsl</code> and
	<code>upload-image.xsp</code></li>
      </ol>
      <s3 title="Sitemap">
	<p>You need to configure the action in your sitemap and you
	need to add a pipeline which invokes the action.</p>

	<s4 title="actions">
	  <source>
	    <![CDATA[
<map:actions>

[...]
  <map:action logger="action.upload" name="file-upload"
    src="org.wyona.cms.cocoon.acting.ArticleImageUploadCreatorAction">
    <images-dir href="resources/images" />
    <meta-dir href="docs/metaDir" />
    <insert-image-before value="false" />
  </map:action>
</map:actions>
]]>
	  </source>
	</s4>
	<s4 title="pipeline">
	  <source>
	    <![CDATA[
<map:match pattern="upload">
  <map:act type="file-upload">
    <!-- if the action suceeds it returns the referer and we
    simply redirect to it. --> 
    <map:redirect-to uri="{$referer}"/>
  </map:act>
  <!-- otherwise the action could not validate some of the
  input and we present the upload form again -->
  <map:generate type="serverpages" src="../../docs/cms/upload-image.xsp"/>
  <map:transform src="../../stylesheets/cms/Page/upload-image.xsl"/>
  <map:serialize type="html"/>
</map:match>
]]>
	  </source>
	</s4>
      </s3>

      <s3 title="request form">
	<p>The request is generated in the html form which is
	generated using upload-image.xsl and upload-image.xsp. Adapt
	those if you have different requirements. Make sure you comply
	with the interfaces outlined below.</p>

	<s4 title="Upload form">
	  <p>The outline form provides the user with the ability to
	  enter a filename and additional information (according to
	  dublin core) pertaining to this file. </p>
	</s4>

      </s3>
      <s3 title="Interfaces">
	  <p>The file upload has two interfaces. The configuration
	  interface via the action parameters and the http post
	  parameters which are passed to the action.</p>
	<s4 title="Sitemap config parameters">
	  <dl>
	    <dt>images-dir</dt>
	    <dd>
	      <source>&lt;images-dir href="resources/images" /&gt;</source>
	      <p>store the upload images at this path (relative to the
	      publication). </p>
	    </dd>
	    <dt>images-dir</dt>
	    <dd><source>&lt;meta-dir href="docs/metaDir" /&gt;</source>
	      <p>store the xml files containing the meta information
	      (dublin core) for the uploaded file at this
	      path(relative to the publication).</p>
	    </dd>
	    <dt>insert-image-before</dt>
	    <dd><source>&lt;insert-image-before value="false" /&gt;</source>
	      <p>Insert the media tag before the xpath if true
	      (default). Insert after otherwise.</p>
	      </dd>
	  </dl>
	</s4>

	<s4 title="Http Request parameters">
	  <p>The following http request parameters are expected from
	  the action. All parameters are of type <code>text</code>
	  except for the parameter uploadFile which is obvioulsly of
	  type <code>file</code>.</p>  
	  
	  <p>Mandatory parameters:</p>
	  <dl>
	    <dt>uploadFile</dt>
	    <dd><p>The file to upload.</p></dd>
	    <dt>xpath</dt>
	    <dd><p>The location at which the image is to be inserted
	    in the document that requested the image upload.</p></dd>
	    <dt>documentid</dt>
	    <dd><p>The document id of the document that requested the
	    image upload. This is used to find the xml document where
	    the media tag has to be inserted at the lopcation given by
	    the <code>xpath</code>.</p></dd>
	    <dt>referer</dt>
	    <dd><p>The url of the document that requested the image
	    upload. This is used to redirect back to it once the image
	    upload is done.</p></dd>
	  </dl>
	<p>Optional parameters:</p>
	  <dl>
	    <dt>insertBefore</dt>
	    <dd><p>Values <code>true</code> or <code>false</code>. Defines if the media element is inserted before or after the given xpath. Overwrites the sitemap configuration parameter <code>insert-image-before</code> if present.</p></dd>
	  </dl>
	  <p>Dublin Core meta data parameters (optional): <br/>
	  All these parameters are stored
	  as meta informarion in the meta data file. See the Dublin
	  Core for an explanation of these parameters.</p> 
	  <dl>
	    <dt>title</dt>
	    <dd><p>Currently also used as alt tag for the image</p></dd>
	    <dt>creator</dt>
	    <dd><p>Currently also used as authorline tag for the image</p></dd>
	    <dt>subject</dt>
	    <dd></dd>
	    <dt>description</dt>
	    <dd><p>Currently also used as media-caption tag for the image</p></dd>
	    <dt>publisher</dt>
	    <dd></dd>
	    <dt>contributor</dt>
	    <dd></dd>
	    <dt>date</dt>
	    <dd></dd>
	    <dt>type</dt>
	    <dd></dd>
	    <dt>format</dt>
	    <dd></dd>
	    <dt>identifier</dt>
	    <dd></dd>
	    <dt>source</dt>
	    <dd></dd>
	    <dt>language</dt>
	    <dd></dd>
	    <dt>relation</dt>
	    <dd></dd>
	    <dt>coverage</dt>
	    <dd></dd>
	    <dt>rights</dt>
	    <dd><p>Currently also used as copyright tag for the image</p></dd>
	  </dl>
	</s4>
      </s3>
    </s2>
    <s2 title="How to customize">
      <p>The easiest way to customize the file upload is probably
      using the action parameters in the sitemap. The other more
      powerful possibility is of course subclassing.</p> 
      <s3 title="action parameters">
	<p>Use the action parameters to change where you want to store
	the images or the meta data files.</p>
      </s3>
      <s3 title="subclassing">
	<p>You might want to subclass the
	<code>ArticleImageUploadCreatorAction</code> e.g. to add a
	different media tag or to have the images stored in a
	different path.</p>
      </s3>
    </s2>
    <s2 title="Limitations/Bugs">

      <dl>
	<dt>Mime Type</dt>
	  <dd><p>The mime type of the uploaded file is not recognized
	  properly.</p></dd> 

	<dt>Validation</dt>
	<dd><p>(*cough*) There is practically no validation of the
	request parameters. This is a potential security problem.</p></dd>

	<dt>wyona integration</dt>
	<dd><p>Uploading an image and inserting it in a document is
	editing this document. It should therefore be integrated with
	the revision controler.</p></dd>

	<dt>not very generic</dt>
	<dd><p>The insertMediaTag method is very specific for the
	unipublic publication. It should be made more generic.</p></dd>
      </dl>
    </s2>
    </s1>
    
  </body>
  <footer>
    <legal></legal>
  </footer>
  </document>
