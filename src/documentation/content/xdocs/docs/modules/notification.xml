<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 2002-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V2.0//EN" "http://forrest.apache.org/dtd/document-v20.dtd">
<document>
  <header>
    <title>Notification</title>
  </header>
  <body>
    
  <section>
    <title>Setup</title>
    
    <ul>
      <li>
        To enable notification by e-mail, you have to download the JavaMail and JavaBeans Activation
        Framework libraries from the <a href="http://java.sun.com/products/javamail/">JavaMail website</a>
        and place them in the <code>&lt;lenya-webapp&gt;/WEB-INF/lib</code> directory.
      </li>
      <li>
        Edit <code>cocoon.xconf</code>, look for the component with the class
        <code>org.apache.lenya.notification.EmailNotifier</code> and update the
        attributes of the <code><![CDATA[<smtp>]]></code> element with the
        settings of your SMTP host.
        The user and password attributes are optional.
        <source xml:space="preserve"><![CDATA[<component logger="lenya.notification"
    role="org.apache.lenya.notification.Notifier"
    class="org.apache.lenya.notification.EmailNotifier">
  <smtp host="localhost" username="john" password="swordfish" />
</component>]]></source>
      </li>
      <li>
        If you test the functionality with the default users lenya and alice,
        don't forget to configure their e-mail addresses.
      </li>
      <li>
        To check if the notification works, go to your
        <a href="http://localhost:8888/default/authoring/index.html?lenya.usecase=notification.inbox">Inbox</a>
        and send a message.
      </li>
    </ul>
    
  </section>
    
<section>
  <title>How to Send Notification Messages</title>
  
  <p>
    There are two ways to send notification messages - either immediately, or by attaching
    a notification event to the current session. In the latter case, the notification is
    sent only if the transaction has been successfully completed.
  </p>
  
  <p>To send notification messages, use the <code>Notifier</code> component which is provided by the
  <code>notification</code> module. A shortcut to the <code>Notifier</code> functionality
  is offered by the <code>NotificationUtil</code> utility class. Here's an example how to
  send a notification message immediately:</p>
  
<source xml:space="preserve"><![CDATA[
protected void notify(User sender, User recipient, document) {

    Identifiable[] recipients = { recipient };
    
    // compose message, using parameters for i18n
    
    String subject = "publish-notification";
    String[] subjectParams = {};
    
    String body = "document-was-published"
    String[] bodyParams = { document.getId() };
    Message message = new Message(subject, subjectParams, body, bodyParams,
                                  sender, recipients);
    
    // send message
    
    NotificationUtil.notify(this.manager, message);
}
]]></source>

  <p>
    The following example shows how to attach a notification event to the session,
    for instance inside a usecase handler:
  </p>
  
  <source xml:space="preserve"><![CDATA[
    NotificationEventDescriptor descriptor = new NotificationEventDescriptor(message);
    RepositoryEvent event = RepositoryEventFactory
        .createEvent(this.manager, authoringDocument, getLogger(), descriptor);
    getSession().enqueueEvent(event);
]]></source>

  <p>
    The message is sent to each particular recipient, translated using the recipient's locale.
  </p>
  
  <p>
    The default implementation, <code>EmailNotifier</code>, sends an email to each recipient
    and adds the message to their inboxes.
    Future implementations could include a message list which is managed by the CMS and is
    presented to a user after she logs in.
  </p>

</section>

  </body>
</document>
