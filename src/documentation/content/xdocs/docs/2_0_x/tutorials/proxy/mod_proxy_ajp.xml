<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 1999-2006 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!-- $Id: metadata.xml 55543 2004-10-26 00:14:59Z gregor $ -->
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V2.0//EN" 
  "http://forrest.apache.org/dtd/document-v20.dtd">
<document>
  <header>
    <title>Running Lenya Behind Apache with mod_proxy_ajp</title>
  </header>
  <body>

    <section>
      <title>Configuring the AJP Connector in Tomcat</title>
      <p>
        The file <code>$TOMCAT_HOME/conf/server.xml</code> contains an AJP 1.3 connector on
        port 8009 by default:
      </p>
      <source xml:space="preserve"><![CDATA[<Connector port="8009" enableLookups="false" redirectPort="8443" protocol="AJP/1.3"/>]]></source>
      <p>
        If the connector is not present, you have to add it.
      </p>
    </section>
    
    <section>
      <title>Configuring the Apache Web Server</title>
      <p>
        Now we'll declare the virtual hosts for the Apache web server. This is done in
        a file called <code>httpd-vhosts.conf</code>. On Mac OS X, it is located in the directory
        <code>/opt/local/apache2/conf/extra</code>. The contents of the file should
        look like this:
      </p>
      <source xml:space="preserve"><![CDATA[NameVirtualHost *:80
NameVirtualHost *:443

# This is the non-SSL host for the authoring area.
<VirtualHost *:80>
    ServerAdmin webmaster@cms.example.com
    ServerName cms.example.com
    ServerAlias cms

    ProxyRequests Off

    RewriteEngine On
    RewriteLog /home/john/src/www/logs/cms.example.com-rewrite_log
    RewriteLogLevel 4
    
    # Redirect the login usecase to https
    RewriteCond %{QUERY_STRING} (.*)lenya\.usecase=ac\.login(.*)
    RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [R,L]

    <Location /lenya/>
      ProxyPass ajp://localhost:8009/lenya/
      ProxyPassReverse http://cms.example.com/lenya/
    </Location>

    <Location /modules/>
      ProxyPass ajp://localhost:8009/modules/
      ProxyPassReverse http://cms.example.com/modules/
    </Location>

    <Location /default/modules/>
      ProxyPass ajp://localhost:8009/default/modules/
      ProxyPassReverse http://cms.example.com/default/modules/
    </Location>

    <Location />
      ProxyPass ajp://localhost:8009/default/authoring/
      ProxyPassReverse http://cms.example.com/default/authoring/
    </Location>

    ErrorLog /home/john/src/www/logs/cms.example.com-error_log
    CustomLog /home/john/src/www/logs/cms.example.com-access_log common
</VirtualHost>

# This is the SSL host for the authoring area.
<VirtualHost *:443>
    ServerName cms.example.com
    ServerAlias cms

    ProxyRequests Off

    SSLEngine On
    SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLCertificateFile /home/john/pki/server.crt
    SSLCertificateKeyFile /home/john/pki/server.key

    <Location /lenya/>
      ProxyPass ajp://localhost:8009/lenya/
      ProxyPassReverse https://cms.example.com/lenya/
    </Location> 

    <Location /modules/>
      ProxyPass ajp://localhost:8009/modules/
      ProxyPassReverse https://cms.example.com/modules/
    </Location>

    <Location /default/modules/>
      ProxyPass ajp://localhost:8009/default/modules/
      ProxyPassReverse https://cms.example.com/default/modules/
    </Location>
    
    <Location />
      ProxyPass ajp://localhost:8009/default/authoring/
      ProxyPassReverse https://cms.example.com/default/authoring/
    </Location>

    ErrorLog /home/john/src/www/logs/ssl.cms.example.com-error_log
    CustomLog /home/john/src/www/logs/ssl.cms.example.com-access_log common

</VirtualHost>

# This is the non-SSL host for the live area.
<VirtualHost *:80>
    ServerAdmin webmaster@www.example.com
    ServerName www.example.com
    ServerAlias www

    ProxyRequests Off

    <Location />
      ProxyPass ajp://localhost:8009/default/live/
      ProxyPassReverse http://www.example.com/default/live/
    </Location>

    ErrorLog /home/john/src/www/logs/www.example.com-error_log
    CustomLog /home/john/src/www/logs/www.example.com-access_log common
</VirtualHost>]]></source>
    </section>
    
  </body>
</document>