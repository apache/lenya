<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 1999-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!-- $Id: website-update.xml 47579 2004-09-30 12:25:51Z thorsten $ -->
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V2.0//EN" "http://forrest.apache.org/dtd/document-v20.dtd">
<document>
	<header>
		<title>Updating the Lenya Website</title>
	</header>
	<body>
		<section>
		<title>Prerequisites</title>
		<p>Before you try to update the Lenya website, make sure you meet the following requirements:</p>
		<ul>
			<li>You have <a href="http://forrest.apache.org">Apache Forrest</a> installed on your machine. This means you have your environment set up
			in a way that you can call <code>forrest</code> in any directory.</li>
			<li>You are an active Lenya committer with write access to SVN.</li>
		</ul>
		<p>If you are not a committer but like to contribute to the documentation, you're most welcome as well. If you
		 want to make additions or corrections to the lenya documentation/website, please keep on reading.</p>
     <p> Instead of committing please make an <code>svn diff</code> of <code>lenya.docu</code> (see above) and contribute the patch via our <a href="site:issue.add">bug tracker</a>. 
    Let us know about it on the developer's mailing list. A committer will happily pick your patch up from the bug tracker and apply it.</p>
    </section>        
    <section>
		<title>First time checkout</title>
    <p>You will have to do this only the first time when doing the website.</p>
    <ul>
      <li><code>svn co https://svn.apache.org/repos/asf/lenya/docu/ lenya.docu</code> <br/><br/><code>lenya.docu</code>->This is our documentation and website source tree. Here you will edit the site.</li>
      <li><code>svn co https://svn.apache.org/repos/asf/lenya/site/ lenya.apache.org</code> <br/><br/><code>lenya.apache.org</code>->This is our website live tree. Here you will have to copy the build of lenya.docu.</li>
    </ul>
    </section>
		<section>
			<title>Generating changes.html</title>
			<p>changes.html can be directly generated from the SVN commit logs with the following procedure:</p>
			<ul>
				<li>install <a href="http://saxon.sf.net">Saxon 8</a> (the svn2changes stylesheet requires a XSLT 2.0 processor)</li>
				<li>run <code>svn log -v --xml http://svn.apache.org/repos/asf/lenya > log.xml</code> in the root of the docu branch. This might take a while as the log file is several MB in size.</li>
				<li>run <code>java -jar saxon8.jar -o status.xml log.xml tools/svn2changes.xsl</code>
				</li>
				<li>run <code>forrest</code> - Forrest will take a LONG TIME to generate changes.html.</li>
			</ul>
      <note>You may have to increase <code>forrest.maxmemory</code> in forrest.properties to get around out of memory exceptions.</note>
			<p>If everything went alright, you will find changes.html, changes.pdf and changes.rss inside your xdocs directory.</p>

		</section>

		<section>
		<title>Understanding the Apache infrastructure</title>
		<p>The Website at <code>http://lenya.apache.org/</code> is a static site, which is served from the checkout dir <code>lenya.apache.org</code> on the server based on
		<code>http://svn.apache.org/repos/asf/lenya/site/</code> by an Apache httpd server.</p>
		<p>The content of <code>lenya.apache.org</code> has to be generated by forrest based on the <code>lenya.docu</code>. 
      This has to be done on your local machine because forrest is <strong>not</strong> installed on the server. </p>
    <p>Copy the deloyed files to your <code>lenya.apache.org</code>. 
      Commit the changes in <code>lenya.apache.org</code>. A cron job updates the static files in <code>lenya.apache.org</code> 
      of the server every 24 hours via a simple <code>svn up</code>.
		</p>
   	</section>
		<section>
			<title>Roundtrip website update</title>
    
		<p>The typical roundtrip process to update the website has the following steps.</p>
    <p>1) edit the documentation src -> lenya.docu</p>
		<ul>
		<li><code>cd $lenya.docu; svn up</code> - change to your local checkout of the docu and update it.</li>
    <li>Follow "Generating changes.html"!</li>
		<li>Run <code>forrest run</code> locally on your machine. You can now browse the website at
		<code>http://localhost:8888/</code>.</li>
		<li>Edit the content using your favourite editor. Refer to the forrest documentation if necessary.
      Hit the Reload button in your browser and test your changes locally on your machine until they work the way you 
		intended.</li>
    </ul>
    <p>2) deploy and commit your changes to the documentation src -> lenya.docu</p>
    <ul>
      <li>Run <code>forrest</code> -> This will create the site in <code>lenya.docu/build/site</code><br/>(Note that Forrest may claim that the build failed, most of the time this is only because of entries in brokenlinks that
    can be ignored. If the site looks ok to you, and there were no validation errors, go for it.)</li>
		<li>Check in your changes (if you are a committer) <code>svn ci -m "my changes message"</code> or prepare a patch (if you aren't) <code>svn diff > patch.txt</code> of <code>lenya.docu</code></li>
    </ul>
    <p>3) copy deployed changes from the documentation src to the website checkout-> lenya.apache.org</p>
    <ul>
    <li><code>cd $lenya.apache.org; svn up</code> - change to your local checkout of the website and update it.</li>
    <li><code>cp -r $lenya.docu/build/site/* .</code> - copy the deployed site from step 2.</li>
    <li>Create and copy the Javadoc for both branches (<code>build javadocs</code>, Copy from <code>build/webapp/site/apidocs</code> to <code>lenya/site/apidocs/1.2</code> and
    <code>lenya/site/apidocs/1.4</code>)</li>
		<li>Commit your changes to lenya.apache.org <code>svn ci -m "my changes message"</code>.</li>
		</ul>
		<p>There is a cron job on minotaur which will do 'svn update' in the server <code>lenya.apache.org</code> dir
every 24 hours (see ~thorsten/thorsten.ct). If you want to do it manually then ...</p>
			<ul>
				<li>Login to <code>minotaur.apache.org</code>
				</li>
				<li>
					<code>minotaur@apache.org &gt; /x1/home/thorsten/bin/lenya-update.sh</code>
				</li>
			</ul>
		</section>

		
	</body>
</document>
