<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 1999-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!-- $Id: source_version.xml 55543 2004-10-26 00:14:59Z gregor $ -->

<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V1.2//EN" "document-v12.dtd">

<document>
  <header>
    <title>Installation of the Source Version</title>
    <version>0.1</version>
    <type>Documentation</type>
    <authors>
      <person name="Lenya community" email="lenya-dev@cocoon.apache.org"/>
    </authors>
  </header>

  <body>
  	<section id="introduction">
  		<title>Introduction</title>
  	
  		<p>
  			This document explains how to install Lenya from source.
  			There are different ways to install and run Lenya:
  			<br/>
  			Choose between
  		</p>
        <ol>
            <li>running Lenya standalone using the built-in Jetty servlet container</li>
            <li>using Tomcat and have the build process taking care of deploying Lenya in Tomcat</li>
            <!--<li>creating a webapp for Tomcat (and other servlet containers) to be deployed manually on a remote server</li>-->
        </ol>

  		<p>
  			Please note that you can use other servlet
        	containers as well, but Jetty and Tomcat are the tested ones.
        </p>
        
        <p>
  			In all cases, you will need to meet the following prerequisites,
  			that describe the setup that is tested and recommended. 
  		</p>
  	
  	</section>
    <section id="prerequisites">
      <title>Prerequisites</title>

      <ul>
      	      	
        <li>
          <p>
            <strong>Java 2 Platform, Standard Edition</strong>
            <br/>
            version 1.4.2 or newer, 1.5.x is not tested yet.
            <br/>
            Get it from <link href="site:java">http://java.sun.com/j2se/1.4.2/download.html</link>
          </p>
        </li>
        
        <li>
      		<p>
      		<strong>Recommended: Create a directory</strong> to better organise the various source files
      		<br/>
      		In this document, we will assume the name <code>src/</code> for that directory. It is important to not have
      		spaces in any of the directory names (so on Windows, make sure you don't create <code>src/</code> in
      		<code>My Documents</code> but rather directly in <code>c:\</code>).
      		This directory will contain the Lenya distribution as well as Cocoon.
      		</p>
      		
      		<p>
      		After expanding the	downloaded archives or after a <link href="site:subversion">svn checkout</link>,
      		the directory structure should look like this:
      		</p>
      		
      		<source>
            your_home/ (or c:\ on Windows, NOT My Documents)
              `-- src/
                   |-- lenya-1.2.x/            $LENYA_HOME
                   `-- cocoon-2.1.6/           $COCOON_HOME
                        `-- build/
                             `-- webapp/       $COCOON_WEBAPP
     		</source>
     		
     		<p>
     		The directories inside cocoon-2.1.6/ will be created when you build Cocoon. 
     		The variables will later be used in the local.build.properties file that configures the Lenya build process.
      		</p>
      		
      	</li>
      	
      	<li>
          <p>
            <strong>Get Apache Lenya</strong>
            <br/>
            (see <link href="site:download">Download Lenya</link>)
            <br/>
            Extract the downloaded Lenya archive in the
            <code>src/</code> directory described above. This will create <code>lenya-1.2.x/</code> inside <code>src/</code>.
            If you use <link href="site:subversion">Subversion</link>, checkout Lenya inside the
            <code>src/</code> directory. 
          </p>
        </li>

        <li>
          <p>
            <strong>Get Apache Cocoon</strong>
            <br/>
            version: 2.1.6
            <br/>
            Get it from <link href="site:cocoon/mirror">http://cocoon.apache.org/mirror.cgi</link><br/>
            Unpack Coccon in <code>src/</code>.
          </p>

			<br/>
			
          <p>
            Note that Cocoon is needed to build the source
            version of Lenya, but the resulting Lenya webapp is
            completely self contained and therefore  does not need
            the Cocoon webapp to be installed. See the <link
            href="site:wiki/lenya/FAQ">FAQ</link>
            for details of configuration changes required when running
            multiple Cocoon based applications.
          </p>
        </li>

        
        <li>
          <p>
            <strong>Build Cocoon</strong>
          </p>

          <p>
       		Copy the Cocoon build properties supplied by Lenya
          </p>

          <ul>
            <li><code>local.build.properties</code></li>
            <li><code>local.blocks.properties</code></li>
          </ul>

          <p>
            from <code>$LENYA_HOME/src/cocoon/</code> to
            <code>$COCOON_HOME</code>.
          </p>
        </li>

        <li>
          <p>
            <strong>Compile Cocoon</strong>
          </p>

          <p>
            <strong>MS Windows</strong>
          </p>

          <source>
            $COCOON_HOME > build.bat
          </source>

          <p>
            <strong>Unix</strong>
          </p>

          <source>
            $COCOON_HOME > ./build.sh -Dinclude.webapp.libs=yes webapp
          </source>
        </li>
        
      </ul>
      
      
    </section>


    <section>
      <title>1: Standalone Installation (using the built-in Jetty)</title>

      <ol>

        <li>
          <p>
            <strong>Configure Lenya to point to Coccon</strong>
          </p>

          <p>
            If your Cocoon source tree is set up as described above, you
            can skip this step.  If your Cocoon source tree is not at
            <code>../cocoon-2.1.6</code> relative to Lenya, you need
            to edit your build properties. To do this, copy
            <code>$LENYA_HOME/build.properties</code> to
            <code>$LENYA_HOME/local.build.properties</code>.
          </p>

          <p>
            Edit <code>local.build.properties</code>. For the described
            configuration the following settings will work (<strong>MS
            Windows:</strong> Don't use backslashes "<code>\</code>" for
            directory separation.)
          </p>

          <ul>
            <li><code>cocoon.src.dir=$COCOON_HOME</code></li>
          </ul>
        </li>

        <li>
          <p>
            <strong>Build Lenya</strong>
          </p>

          <p>
            Execute <code>build.bat</code> or <code>build.sh</code> in
            your Lenya source directory, depending on your platform.
          </p>

          <p>
            <strong>MS Windows</strong>
          </p>

          <source>
            $LENYA_HOME > build.bat
          </source>

          <p>
            <strong>Unix</strong>
          </p>

          <source>
            $LENYA_HOME > ./build.sh
          </source>
        </li>

        <li>
          <p>
            <strong>Start Lenya</strong>
          </p>

          <p>
            Execute <code>lenya.bat</code> or <code>lenya.sh
            servlet</code> in your Lenya source directory, depending on
            your platform.  Make sure that you have the environment
            variable <code>JAVA_HOME</code> defined to point to the
            location of the Java SDK you installed (see <link
            href="#prerequisites">Prerequisites</link>).
          </p>

          <p>
            <strong>MS Windows</strong>
          </p>

          <source>
            $LENYA_HOME > lenya.bat
          </source>

          <p>
            <strong>Unix</strong>
          </p>

          <source>
            $LENYA_HOME > ./lenya.sh servlet
          </source>
        </li>

        <li>
          <p>
            <strong>Test the installation</strong>
          </p>

          <p>
            <link href="http://localhost:8888">http://localhost:8888/</link>
          </p>
        </li>
      </ol>
    </section>

    <section>
      <title>2: Installation with Apache Tomcat</title>

      <ol>

		<li>
          <p>
            <strong>Get Apache Tomcat</strong> for JDK 1.4
            <br/>
            version: 5.0.28 or newer, 5.5.x not tested.
            <br/>
            Get it from  <link href="site:tomcat5">http://jakarta.apache.org/site/binindex.cgi#tomcat-5.0</link>
          </p>

        </li>
        
        <li>
          <p>
            <strong>Install Apache Tomcat</strong>
          </p>

          <p>
            See <link
            href="site:tomcat5.setup">Tomcat 5.0 Setup</link>
          </p>

          <p>
            <strong>MS Windows:</strong>

            <br/>

            Basically you only need to set the <code>JAVA_HOME</code>
            environment variable and run the Tomcat
            installer. Decide to run Tomcat as a Windows
            NT/2000/XP-Service.
          </p>

          <warning>
            Make sure you do not install Tomcat at a location with spaces in
            the path.
          </warning>
        </li>

        <li>
          <p>
            <strong>Configure Lenya</strong>
          </p>

          <p>
            To install Lenya with Tomcat, you need to edit your build
            properties. To do this, copy
            <code>$LENYA_HOME/build.properties</code> to
            <code>$LENYA_HOME/local.build.properties</code>.
          </p>

          <p>
            Edit <code>local.build.properties</code>. For the described
            configuration the following settings will work (<strong>MS
            Windows:</strong> Don't use backslashes "<code>\</code>" for
            directory separation.) It is important that
            <code>tomcat.home.dir</code> is an absolute path. Replace
            <code>$TOMCAT_HOME</code> by your Tomcat installation
            directory.  If your Cocoon source directory is not at
            <code>../cocoon-2.1.6</code> relative to Lenya, then change
            the <code>cocoon.webapp.dir</code> and
            <code>cocoon.src.dir</code> properties.
          </p>

          <ul>
            <li><code>cocoon.src.dir=$COCOON_HOME</code></li>
            <li><code>tomcat.home.dir=$TOMCAT_HOME</code></li>
          </ul>
        </li>

        <li>
          <p>
            <strong>Build Lenya</strong>
          </p>

          <p>
            Execute <code>build</code> in your Lenya source directory.
          </p>
        </li>

      <li>
        <p>
          <strong>Checked versions of endorsed libraries</strong>
        </p>
    
        <p>
          Lenya and Tomcat will inter-operate correctly only if the proper
          versions of the Xalan and Xerces libraries are used consistently
          throughout the deployment.  Unfortunately this can be difficult
          to get to work correctly since both of these libraries are
          shipped with Java 2 SDK, Tomcat, Cocoon and Lenya.
        </p>
    
        <p>
          The following libraries must be placed in the endorsed library
          directory for your deployment.
        </p>
    
        <ul>
          <li><code>jakarta-bcel-20040329.jar</code></li>
          <li><code>jakarta-regexp-1.3.jar</code></li>
          <li><code>xalan-2.6.0.jar</code></li>
          <li><code>xercesImpl-2.6.2.jar</code></li>
          <li><code>xml-apis.jar</code></li>
        </ul>
    
        <p>
          They are placed by the build process in the directory specified
          by <code>tomcat.endorsed.dir</code> in
          <code>build.properties</code>.  You should validate that these
          files are indeed in the proper location for your deployment.
          You must then validate that no other instances of these
          libraries exist in any of the following directories:
        </p>
    
        <ul>
          <li>
            The Java 2 SDK endorsed standards directories.  This is
            usually <code>${JAVA_HOME}/lib/endorsed/</code>.
          </li>
    
          <li>
            Any other location in your Tomcat deployment.  Specifically,
            check <code>shared/lib/</code>, <code>common/lib/</code> and
            <code>server/lib/</code>.
          </li>
    
          <li>
            Any other location in your Lenya deployment.  Specifically,
            check <code>webapps/lenya/WEB-INF/lib/</code>.
          </li>
        </ul>
    
        <p>
          A common symptom of incorrect library version are blank pages
          after starting Lenya.  Try carefully checking the location and
          version numbers of each of the libraries.
        </p>
    
        <p>
          References:
        </p>
    
        <ul>
          <li>
            <link href="site:tomcat5.classloader">
              Tomcat Class Loader HOWTO (http://jakarta.apache.org/tomcat/tomcat-5.0-doc/class-loader-howto.html)
            </link>
          </li>
    
          <li>
            <link href="site:java.endorsedmechanism">
              Java 2 Endorsed Standards Override Mechanism
              (http://java.sun.com/j2se/1.4.2/docs/guide/standards/index.html)
            </link>
          </li>
        </ul>
      </li>
         <li>
           <p>
            <strong>Clear Tomcat work directory</strong>
          </p>

          <p>
            Tomcat's work cache may not be consistent with your newly installed
            Lenya.  This can lead to any number of errors and exceptions.  To
            prevent this, clear the work directory by executing
            <code>build.bat</code> or <code>build.sh</code> in your Lenya source
            directory, depending on your platform.
          </p>

          <p>
            <strong>MS Windows</strong>
          </p>

          <source>
            $LENYA_HOME > build.bat clean 
          </source>

          <p>
            <strong>Unix</strong>
          </p>

          <source>
            $LENYA_HOME > ./build.sh clean
          </source>
        </li>
        <li>
          <p>
            <strong>Restart Tomcat</strong>
          </p>

          <p>
            Restart Tomcat to load the Lenya webapp.
          </p>
        </li>

        <li>
          <p>
            <strong>Test the installation</strong>
          </p>

          <p>
            <link href="http://localhost:8080/lenya">http://localhost:8080/lenya/</link>
          </p>
        </li>
      </ol>
    </section>
  </body>
</document>
