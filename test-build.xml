<?xml version="1.0"?>

<project default="junit.tests" name="lenya" basedir=".">

<!-- === Test targets =========================================================== -->

<target name="init">
    <property name="build.test" value="build/test"/>
    <property name="test" value="src/test"/>
    <property name="target.vm"      value="1.4"/>
  <property name="lib.dir" value="lib"/>

  <property name="build.root" value="build"/>
  <property name="build.dir" value="${build.root}/${ant.project.name}"/>
  <property name="build.webapp" value="${build.dir}/webapp"/>

  <path id="classpath">
    <fileset dir="${lib.dir}">
      <include name="*.jar"/>
    </fileset>
    <fileset dir="${build.webapp}/WEB-INF/lib">
      <include name="*.jar"/>
    </fileset>
    <!--<pathelement path="${java.class.path}/"/>-->
  </path>
</target>

  <!-- Runs all tests -->
  <target name="test" depends="junit.tests, anteater.tests" description="Runs all tests"/>

  <!-- Runs JUnit tests -->
  <target name="junit.tests" depends="init">
  <!--<target name="junit.tests" depends="compile">-->
    <mkdir dir="${build.test}"/>

    <!-- Copy test files to build test dir -->
    <copy todir="${build.test}" filtering="on">
      <fileset dir="${test}" excludes="**/*.java"/>
    </copy>

    <!-- Compile tests -->
    <javac srcdir="${test}"
           destdir="${build.test}"
           debug="{debug}"
           optimize="{optimize}"
           deprecation="{deprecation}"
           target="${target.vm}"
           fork="true">
      <classpath refid="classpath"/>
      <classpath>
        <pathelement path="${build.dest}" />
        <!-- FIXME Resolver tests depend on deprecated stuff -->
<!--
        <pathelement path="${build.deprecated}" />
-->
      </classpath>
    </javac>

    <!-- Run tests -->
<!--
    <junit printsummary="yes" haltonfailure="yes" fork="yes">
      <classpath>
        <pathelement location="${build.test}" />
        <pathelement location="${build.dest}" />
-->
        <!-- FIXME Resolver tests depend on deprecated stuff -->
<!--
        <pathelement path="${build.deprecated}" />
        <pathelement path="${java.class.path}" />
      </classpath>
      <classpath refid="classpath"/>
      <formatter type="plain" usefile="no" />
      <batchtest>
        <fileset dir="${build.test}">
          <include name="**/*TestCase.class"/>
          <include name="**/*Test.class" />
          <exclude name="**/AllTest.class" />
          <exclude name="**/*$$*Test.class" />
          <exclude name="**/Abstract*.class" />
        </fileset>
      </batchtest>
    </junit>
-->
  </target>

  <!-- Anteater tests  -->
  <target name="anteater.tests">
    <property name="host" value="localhost"/>
    <property name="port" value="8888"/>
    <property name="base" value="/"/>

    <!-- FIXME: Anteater invocation is platform specific
    <exec executable="cmd">
      <arg line="/C C:\Java\anteater-0.9.15\bin\anteater.bat -f src/test/anteater/all-tests.xml -Dhost=${host} -Dport=${port} -Dbase=${base}"/>
    </exec>
    <exec executable="anteater">
      <arg line="-f src/test/anteater/all-tests.xml -Dhost=${host} -Dport=${port} -Dbase=${base}"/>
    </exec>
    -->
  </target>

</project>
